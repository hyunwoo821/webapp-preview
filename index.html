<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²½ë ¥ ìˆ˜ì • íë¦„ ë°ëª¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script>
    tailwind = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          },
        },
      },
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <!-- âœ… ê¸°ì¡´ index.htmlì—ì„œ ì“°ë˜ ì»¤ìŠ¤í…€ CSS -->
  <style>
    body { background-color: #f3f4f6; }

    .step-indicator {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 9999px;
      border: 2px solid #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #6b7280;
      background: white;
    }
    .step-indicator.active {
      background-color: #2563eb;
      border-color: #2563eb;
      color: white;
    }
    .step-indicator.completed {
      background-color: #22c55e;
      border-color: #22c55e;
      color: white;
    }

    .career-card {
      background: white;
      transition: all 0.2s ease;
    }
    .career-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .career-card.selected {
      border-color: #2563eb !important;
      background-color: #eff6ff;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body class="min-h-screen">

  <div class="max-w-5xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-lg">

    <!-- Step Indicator -->
    <div class="flex justify-between mb-10">
      <div id="step-indicator-1" class="step-indicator">1</div>
      <div id="step-indicator-2" class="step-indicator">2</div>
      <div id="step-indicator-3" class="step-indicator">3</div>
      <div id="step-indicator-4" class="step-indicator">4</div>
      <div id="step-indicator-5" class="step-indicator">5</div>
    </div>

    <!-- ë™ì  ì½˜í…ì¸  -->
    <div id="app-content"></div>

    <!-- ë²„íŠ¼ -->
    <div class="flex justify-between items-center mt-12">
      <button
        id="btn-prev"
        class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 hidden"
      >
        ì´ì „
      </button>

      <button
        id="btn-next"
        class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-blue-700 transition"
      >
        ë‹¤ìŒ
      </button>
    </div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div
    id="modal"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden"
  >
    <div class="bg-white rounded-xl p-6 max-w-md w-full relative shadow-lg">
      <button
        id="modal-close"
        class="absolute top-3 right-3 text-gray-400 hover:text-black"
      >
        âœ•
      </button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- axios (data.json ê·¸ëŒ€ë¡œ ì“°ê¸° ìœ„í•´ ìœ ì§€) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- ========================= -->
    <!-- ğŸ”¥ ì—¬ê¸°ë¶€í„° app.js ë‚´ìš© ğŸ”¥ -->
    <!-- ========================= -->
  <script>
    // ì „ì—­ ìƒíƒœ ê´€ë¦¬
    const state = {
        currentStep: 0,
        data: null,
        selectedEngineer: null, //ê¸°ìˆ ì¸ ì„ íƒ
        selectedItems: [], // ì„ íƒëœ í•­ëª©ì½”ë“œë“¤
        selectedCareer: null, // ì„ íƒëœ ê²½ë ¥ (í‘œ3 ë°ì´í„°)
        modifiedFields: {}, // ìˆ˜ì •ëœ í•„ë“œë“¤
        matchedRule: null, // ë§¤ì¹­ëœ ê·œì¹™ (í‘œ2 ë°ì´í„°)
        needsExtraDoc: false, // C1203 ì¶”ê°€ ì„œë¥˜ í•„ìš” ì—¬ë¶€
        uploadedFiles: {}, // ì—…ë¡œë“œëœ íŒŒì¼ë“¤
        submissionData: null // ì œì¶œ ë°ì´í„°
    };

    // ì´ˆê¸°í™”
    async function init() {
        try {
            const response = await axios.get('/data.json');
            state.data = response.data;
            console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', state.data);
            renderStep(0);
            setupEventListeners();
        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            showModal('<p class="text-red-600">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>');
        }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
        document.getElementById('btn-next').addEventListener('click', handleNext);
        document.getElementById('btn-prev').addEventListener('click', handlePrev);
        document.getElementById('modal-close').addEventListener('click', closeModal);
    }

    // ë‹¤ìŒ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function handleNext() {
        if (state.currentStep === 0) {
            // Step0 ê²€ì¦: í•­ëª©ì´ ì„ íƒë˜ì—ˆëŠ”ì§€
            if (!state.selectedEngineer) {
                showModal('<p class="text-red-600">ê¸°ìˆ ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>');
                return;
            }
        }
        if (state.currentStep === 1) {
            // Step1 ê²€ì¦: í•­ëª©ì´ ì„ íƒë˜ì—ˆëŠ”ì§€
            const checkboxes = document.querySelectorAll('input[name="item-select"]:checked');
            if (checkboxes.length === 0) {
                showModal('<p class="text-red-600">ìµœì†Œ 1ê°œ ì´ìƒì˜ ìˆ˜ì •í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>');
                return;
            }
            state.selectedItems = Array.from(checkboxes).map(cb => cb.value);
            console.log('ì„ íƒëœ í•­ëª©:', state.selectedItems);
        } else if (state.currentStep === 2) {
            // Step2 ê²€ì¦: ê²½ë ¥ì´ ì„ íƒë˜ì—ˆëŠ”ì§€
            if (!state.selectedCareer) {
                showModal('<p class="text-red-600">ìˆ˜ì •í•  ê²½ë ¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>');
                return;
            }
        } else if (state.currentStep === 3) {
            
            // Step3 ê²€ì¦: ìˆ˜ì •ì‚¬í•­ì´ ì…ë ¥ë˜ì—ˆëŠ”ì§€
            const hasModifications = Object.keys(state.modifiedFields).length > 0;
            if (!hasModifications) {
                showModal('<p class="text-red-600">ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</p>');
                return;
            }
            // ê·œì¹™ ë¶„ì„ ì‹¤í–‰
            analyzeRules();
        } else if (state.currentStep === 4) {
            // Step4: ì„œë¥˜ ì—…ë¡œë“œ ê²€ì¦ (í˜„ì¬ëŠ” ìŠ¤í‚µ ê°€ëŠ¥)
            // ì œì¶œ ë°ì´í„° ì¤€ë¹„
            prepareSubmissionData();
        }

        // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
        if (state.currentStep < 5) {
            state.currentStep++;
            renderStep(state.currentStep);
        }
    }

    // ì´ì „ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function handlePrev() {
        if (state.currentStep > 1) {
            state.currentStep--;
            renderStep(state.currentStep);
        }
    }

    // ë‹¨ê³„ë³„ ë Œë”ë§
    function renderStep(step) {
        const content = document.getElementById('app-content');
        const prevBtn = document.getElementById('btn-prev');
        const nextBtn = document.getElementById('btn-next');

        // ë‹¨ê³„ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
        for (let i = 1; i <= 5; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            indicator.classList.remove('active', 'completed');
            if (i === step) {
                indicator.classList.add('active');
            } else if (i < step) {
                indicator.classList.add('completed');
            }
        }

        // ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        prevBtn.classList.toggle('hidden', step === 1);
        
        if (step === 5) {
            nextBtn.innerHTML = '<i class="fas fa-check mr-2"></i>ì œì¶œ';
        } else {
            nextBtn.innerHTML = 'ë‹¤ìŒ<i class="fas fa-arrow-right ml-2"></i>';
        }

        // ë‹¨ê³„ë³„ ì»¨í…ì¸  ë Œë”ë§
        switch (step) {
            case 0:
                renderStep0(content);
                break;
            case 1:
                renderStep1(content);
                break;
            case 2:
                renderStep2(content);
                break;
            case 3:
                renderStep3(content);
                break;
            case 4:
                renderStep4(content);
                break;
            case 5:
                renderStep5(content);
                break;
        }
    }
    // Step0 : ê¸°ìˆ ì¸ ì„ íƒ
    function renderStep0(content) {
        const engineer = state.data.engineers;
        const isSelected = state.selectedEngineer?.engineerId === engineer.engineerId;

        const engineers = state.data.engineers;

        let html = `
            <h2 class="text-2xl font-bold mb-4">ê¸°ìˆ ì¸ ì„ íƒ</h2>
            <div class="space-y-4 max-w-md">
        `;

        engineers.forEach(engineer => {
            const isSelected = state.selectedEngineer?.engineerId === engineer.engineerId;
            html += `
                <div class="career-card border-2 rounded-lg p-4 cursor-pointer
                    ${isSelected ? 'selected border-blue-600' : 'border-gray-200'}"
                    onclick="selectEngineer('${engineer.engineerId}')">
                    <div class="font-bold">${engineer.name}</div>
                    <div class="text-sm text-gray-500">ID: ${engineer.engineerId}</div>
                </div>
            `;
        });

        html += `</div>`;
        content.innerHTML = html;
    }

    //ê¸°ìˆ ì¸ ì„ íƒ í•¨ìˆ˜
    function selectEngineer(engineerId) {
        state.selectedEngineer = state.data.engineers.find(
            e => e.engineerId === engineerId
        );
        renderStep(0);
    }



    // Step1: ìˆ˜ì •í•­ëª© ì„ íƒ
    function renderStep1(content) {
        const items = state.data.table1;
        
        let html = `
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-list-check mr-2 text-blue-600"></i>
                ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”
            </h2>
            <p class="text-gray-600 mb-6">ë³€ê²½í•˜ê³ ì í•˜ëŠ” í•­ëª©ì„ ì²´í¬ë°•ìŠ¤ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        `;

        items.forEach(item => {
            const isChecked = state.selectedItems.includes(item.í•­ëª©ì½”ë“œ);
            html += `
                <label class="career-card border-2 rounded-lg p-4 cursor-pointer hover:shadow-md ${isChecked ? 'selected' : 'border-gray-200'}">
                    <div class="flex items-center">
                        <input type="checkbox" name="item-select" value="${item.í•­ëª©ì½”ë“œ}" 
                            class="w-5 h-5 text-blue-600 mr-3" ${isChecked ? 'checked' : ''}>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${item.í•­ëª©ëª…}</div>
                            <div class="text-sm text-gray-500">${item.í•­ëª©ì½”ë“œ}</div>
                        </div>
                    </div>
                </label>
            `;
        });

        html += `</div>`;
        content.innerHTML = html;

        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('input[name="item-select"]').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const label = e.target.closest('label');
                if (e.target.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        });
    }

    // Step2: ìˆ˜ì • ê²½ë ¥ ì„ íƒ
    function renderStep2(content) {
        const careers = state.data.table3.filter(
            c => c.engineerId === state.selectedEngineer.engineerId
        );
        state.filteredCareers = careers;
        const selectedItemNames = state.selectedItems.map(code => {
            const item = state.data.table1.find(i => i.í•­ëª©ì½”ë“œ === code);
            return item ? item.í•­ëª©ëª… : code;
        }).join(', ');

        let html = `
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-briefcase mr-2 text-blue-600"></i>
                ìˆ˜ì •í•  ê²½ë ¥ì„ ì„ íƒí•˜ì„¸ìš”
            </h2>
            <p class="text-gray-600 mb-2">ì„ íƒí•œ ìˆ˜ì •í•­ëª©: <strong class="text-blue-600">${selectedItemNames}</strong></p>
            <p class="text-gray-500 mb-6 text-sm">ê¸°ì¡´ì— ì‹ ê³ ëœ ê²½ë ¥ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            
            <div class="space-y-4">
        `;

        careers.forEach((career, index) => {
            // index ê¸°ë°˜ìœ¼ë¡œ ì„ íƒ ì—¬ë¶€ íŒë‹¨ (ì¼€ì´ìŠ¤ID ì œê±°ë¨)
            const isSelected = state.selectedCareer && state.selectedCareer._index === index;
            
            // ëª¨ë“  í•„ë“œë¥¼ 4ì¤„ë¡œ í‘œì‹œ
            const fields = Object.entries(career);
            const fieldsPerRow = Math.ceil(fields.length / 4);
            
            let rows = [];
            for (let i = 0; i < 4; i++) {
                const rowFields = fields.slice(i * fieldsPerRow, (i + 1) * fieldsPerRow);
                if (rowFields.length > 0) {
                    rows.push(rowFields);
                }
            }

            html += `
                <div class="career-card border-2 rounded-lg p-4 cursor-pointer ${isSelected ? 'selected' : 'border-gray-200'}" 
                    onclick="selectCareer(${index})">
                    <div class="flex items-start mb-3">
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 mt-1 
                            ${isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-300'}">
                            ${isSelected ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-800 mb-2">ê²½ë ¥ #${index + 1}</h3>
            `;

            rows.forEach(row => {
                html += `<div class="grid grid-cols-2 md:grid-cols-${Math.min(row.length, 3)} gap-2 mb-2 text-sm">`;
                row.forEach(([key, value]) => {
                    const displayValue = value || '-';
                    html += `
                        <div>
                            <span class="text-gray-500">${key}:</span>
                            <span class="text-gray-800 font-medium ml-1">${displayValue}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        content.innerHTML = html;
    }

    // ê²½ë ¥ ì„ íƒ í•¨ìˆ˜
    function selectCareer(index) {
        const career = state.filteredCareers[index];
        state.selectedCareer = {
            ...career,
            _index: index
        };
        console.log('ì„ íƒëœ ê²½ë ¥:', state.selectedCareer);
        renderStep(2); // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    }

    // Step3: ìˆ˜ì •ì‚¬í•­ ì…ë ¥
    function renderStep3(content) {
        const career = state.selectedCareer;
        const selectedItemCodes = state.selectedItems;
        
        // ì„ íƒëœ í•­ëª©ì— í•´ë‹¹í•˜ëŠ” í•„ë“œëª… ì°¾ê¸°
        const editableFields = selectedItemCodes.map(code => {
            const item = state.data.table1.find(i => i.í•­ëª©ì½”ë“œ === code);
            return item ? item.í•­ëª©ëª… : code;
        });
        
        // í•„ë“œëª… ë§¤ì¹­ì„ ìœ„í•œ í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜
        function getFieldKeywords(itemName) {
            const keywords = [];
            // "ì§ë¬´Â·ì „ë¬¸ë¶„ì•¼" -> ["ì§ë¬´", "ì „ë¬¸"]
            if (itemName.includes('Â·')) {
                const parts = itemName.split('Â·');
                parts.forEach(part => {
                    // "(ìˆ˜ì •)", "(ì·¨ì†Œ)" ë“± ì œê±°
                    const cleaned = part.replace(/\(.*?\)/g, '').trim();
                    if (cleaned) keywords.push(cleaned);
                });
            } else {
                // ë‹¨ì¼ í•„ë“œëª…ì—ì„œ ê´„í˜¸ ì œê±°
                const cleaned = itemName.replace(/\(.*?\)/g, '').trim();
                if (cleaned) keywords.push(cleaned);
            }
            return keywords;
        }
        
        // ì„ íƒëœ í•­ëª©ì˜ ëª¨ë“  í‚¤ì›Œë“œ ìˆ˜ì§‘
        const allKeywords = [];
        editableFields.forEach(field => {
            allKeywords.push(...getFieldKeywords(field));
        });

        let html = `
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-pen-to-square mr-2 text-blue-600"></i>
                ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”
            </h2>
            <p class="text-gray-600 mb-6">ì¢Œì¸¡ì—ëŠ” ê¸°ì¡´ ì •ë³´ê°€, ìš°ì¸¡ì—ëŠ” ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª©ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ì¢Œì¸¡: ê¸°ì¡´ ì •ë³´ -->
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">
                        <i class="fas fa-file-lines mr-2"></i>ê¸°ì¡´ ì‹ ê³  ë‚´ìš©
                    </h3>
                    <div class="space-y-3">
        `;

        Object.entries(career).forEach(([key, value]) => {
            // _indexëŠ” ë‚´ë¶€ ì‹ë³„ìì´ë¯€ë¡œ ì œì™¸
            if (key === '_index') {
                return;
            }
            
            const displayValue = value || '-';
            html += `
                <div class="flex border-b border-gray-200 pb-2">
                    <div class="w-1/3 text-gray-600 text-sm font-medium">${key}</div>
                    <div class="w-2/3 text-gray-800">${displayValue}</div>
                </div>
            `;
        });

        html += `
                    </div>
                </div>

                <!-- ìš°ì¸¡: ìˆ˜ì • ì…ë ¥ -->
                <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">
                        <i class="fas fa-edit mr-2 text-blue-600"></i>ìˆ˜ì •í•  í•­ëª©
                    </h3>
                    <form id="edit-form" class="space-y-4">
        `;

        Object.entries(career).forEach(([key, value]) => {
            // _indexëŠ” ë‚´ë¶€ ì‹ë³„ìì´ë¯€ë¡œ ì œì™¸
            if (key === '_index') {
                return;
            }
            
            // í•„ë“œê°€ í¸ì§‘ ê°€ëŠ¥í•œì§€ í™•ì¸ (í‚¤ì›Œë“œ ê¸°ë°˜ ë§¤ì¹­)
            const isEditable = allKeywords.some(keyword => {
                // í•„ë“œëª…ì— í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                return key.includes(keyword);
            });
            
            // ìˆ˜ì • í•­ëª©ì€ ë¹ˆê°’ìœ¼ë¡œ ì‹œì‘, ë¹„ìˆ˜ì • í•­ëª©ì€ ê¸°ì¡´ ê°’ í‘œì‹œ
            const currentValue = state.modifiedFields[key] !== undefined 
                ? state.modifiedFields[key] 
                : (isEditable ? '' : (value || ''));
            
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${key}</label>
                    <input type="text" 
                        name="${key}" 
                        value="${currentValue}"
                        class="w-full px-3 py-2 border rounded-lg ${isEditable ? 'bg-white border-blue-300 focus:ring-2 focus:ring-blue-500' : 'bg-gray-100 border-gray-300 cursor-not-allowed'}"
                        ${isEditable ? '' : 'readonly'}
                        placeholder="${isEditable ? 'ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”' : 'ìˆ˜ì • ë¶ˆê°€'}">
                </div>
            `;
        });

        html += `
                    </form>
                    <button onclick="saveModifications()" class="mt-6 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>ìˆ˜ì • ë‚´ìš© ì €ì¥
                    </button>
                </div>
            </div>
        `;

        content.innerHTML = html;
    }

    // ìˆ˜ì • ë‚´ìš© ì €ì¥
    function saveModifications() {
        const form = document.getElementById('edit-form');
        const formData = new FormData(form);
        
        state.modifiedFields = {};
        let hasChanges = false;

        for (let [key, value] of formData.entries()) {
            // _indexëŠ” ì œì™¸
            if (key === '_index') continue;
            
            const originalValue = state.selectedCareer[key] || '';
            // ë¹ˆ ê°’ì´ ì•„ë‹ˆê³ , ì›ë˜ ê°’ê³¼ ë‹¤ë¥´ë©´ ìˆ˜ì •ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
            if (value && value.trim() !== '' && value !== originalValue) {
                state.modifiedFields[key] = value;
                hasChanges = true;
            }
        }

        if (!hasChanges) {
            showModal('<p class="text-yellow-600">ë³€ê²½ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>');
            return;
        }

        console.log('ìˆ˜ì •ëœ í•„ë“œ:', state.modifiedFields);
        showModal('<p class="text-green-600"><i class="fas fa-check-circle mr-2"></i>ìˆ˜ì • ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</p>');
    }

    // Step3ì—ì„œ ê·œì¹™ ë¶„ì„
    function analyzeRules() {
        const rules = state.data.table2;
        const career = state.selectedCareer;
        const modifications = state.modifiedFields;

        console.log('ê·œì¹™ ë¶„ì„ ì‹œì‘:', { career, modifications });

        // ì„ íƒëœ í•­ëª©ì½”ë“œì™€ ì¼ì¹˜í•˜ëŠ” ê·œì¹™ ì°¾ê¸°
        let matchedRule = null;
        let highestPriority = -1;
        let needsExtraDoc = false;

        // ê° í•­ëª©ì½”ë“œì— ëŒ€í•´ ë§¤ì¹­ë˜ëŠ” ê·œì¹™ ì°¾ê¸°
        for (let itemCode of state.selectedItems) {
            // í•´ë‹¹ í•­ëª©ì½”ë“œì˜ ê·œì¹™ë“¤ í•„í„°ë§
            const candidateRules = rules.filter(rule => rule.í•­ëª©ì½”ë“œ === itemCode);
            
            if (candidateRules.length === 0) continue;
            
            // ì—¬ëŸ¬ ê·œì¹™ì´ ìˆìœ¼ë©´ ì¡°ê±´ í‰ê°€
            for (let rule of candidateRules) {
                const conditionResult = evaluateCondition(rule, career, modifications);
                
                console.log(`ê·œì¹™ ${rule.ì¼€ì´ìŠ¤ID} í‰ê°€:`, conditionResult);
                
                if (conditionResult.matched && conditionResult.priority > highestPriority) {
                    matchedRule = rule;
                    highestPriority = conditionResult.priority;
                    needsExtraDoc = conditionResult.needsExtraDoc || false;
                }
            }
        }

        // ë§¤ì¹­ëœ ê·œì¹™ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê·œì¹™ ì‚¬ìš©
        if (!matchedRule && state.selectedItems.length > 0) {
            matchedRule = rules.find(rule => state.selectedItems.includes(rule.í•­ëª©ì½”ë“œ));
        }

        state.matchedRule = matchedRule;
        state.needsExtraDoc = needsExtraDoc;
        console.log('ìµœì¢… ë§¤ì¹­ëœ ê·œì¹™:', matchedRule);
        console.log('ì¶”ê°€ ì„œë¥˜ í•„ìš”:', needsExtraDoc);
    }

    // ì¡°ê±´ í‰ê°€ í•¨ìˆ˜
    function evaluateCondition(rule, career, modifications) {
        const condition = rule.ì¡°ê±´;
        
        // ì¡°ê±´ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë§¤ì¹­
        if (!condition) {
            return { matched: true, priority: 0 };
        }

        // ë¹„êµê°’ë“¤ ì¶”ì¶œ
        const ë¹„êµê°’1 = rule.ë¹„êµê°’1; // ì˜ˆ: "ì§ë¬´ë¶„ì•¼"
        const ë¹„êµê°’2 = rule.ë¹„êµê°’2; // ì˜ˆ: "ìˆ˜ì • ì§ë¬´ë¶„ì•¼"
        const ë¹„êµê°’3 = rule.ë¹„êµê°’3; // ì˜ˆ: "ì „ë¬¸ë¶„ì•¼"
        const ë¹„êµê°’4 = rule.ë¹„êµê°’4; // ì˜ˆ: "ìˆ˜ì • ì „ë¬¸ë¶„ì•¼"

        // ì‹¤ì œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const ê¸°ì¡´_ì§ë¬´ë¶„ì•¼ = career['ì§ë¬´ë¶„ì•¼'] || '';
        const ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ = modifications['ì§ë¬´ë¶„ì•¼'] || '';
        const ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ = career['ì „ë¬¸ë¶„ì•¼'] || '';
        const ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ = modifications['ì „ë¬¸ë¶„ì•¼'] || '';
        const ê¸°ì¡´_ë‹´ë‹¹ì—…ë¬´ = career['ë‹´ë‹¹ì—…ë¬´'] || '';
        const ìˆ˜ì •_ë‹´ë‹¹ì—…ë¬´ = modifications['ë‹´ë‹¹ì—…ë¬´'] || '';
        const ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª… = career['ì°¸ì—¬ì‚¬ì—…ëª…'] || '';
        const ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª… = modifications['ì°¸ì—¬ì‚¬ì—…ëª…'] || '';
        const ê¸°ì¡´_ë°œì£¼ì = career['ë°œì£¼ì'] || '';
        const ìˆ˜ì •_ë°œì£¼ì = modifications['ë°œì£¼ì'] || '';
        const ë³´ìœ ê±´ì„¤ì—… = career['ë³´ìœ ê±´ì„¤ì—…'] || '';
        const ì±…ì„ì •ë„ = career['ì±…ì„ì •ë„'] || '';
        const ì¢…ë£Œì‹ ê³ ì¼ = career['ì¢…ë£Œì‹ ê³ ì¼'] || '';
        const ê·¼ë¬´ì²˜ëª… = career['ê·¼ë¬´ì²˜ëª…'] || '';
        const ë°œì£¼ì²­ì†Œì† = career['ë°œì£¼ì²­ì†Œì†'] || '';

        console.log('ì¡°ê±´ í‰ê°€ ë°ì´í„°:', {
            ê¸°ì¡´_ì§ë¬´ë¶„ì•¼, ìˆ˜ì •_ì§ë¬´ë¶„ì•¼,
            ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼, ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼,
            ì¡°ê±´: condition
        });
        
        // C0801: (ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ í¬í•¨) and (ìˆ˜ì • ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ ë¯¸í¬í•¨)
        if (rule.ì¼€ì´ìŠ¤ID === 'C0801') {
            const ì°¸ì—¬ì‚¬ì—…ì¡°ê±´ =
                includesText(ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª…, 'ë³¸ì‚¬') &&
                !includesText(ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…, 'ë³¸ì‚¬');
            
            const ë‹´ë‹¹ì—…ë¬´_ìˆ˜ì •ì•ˆí•¨ = modifications['ë‹´ë‹¹ì—…ë¬´'] === undefined;
            const ë‹´ë‹¹ì—…ë¬´_ë™ì¼ =
                modifications['ë‹´ë‹¹ì—…ë¬´'] !== undefined &&
                ê¸°ì¡´_ë‹´ë‹¹ì—…ë¬´ === ìˆ˜ì •_ë‹´ë‹¹ì—…ë¬´;
            if (ì°¸ì—¬ì‚¬ì—…ì¡°ê±´ && (ë‹´ë‹¹ì—…ë¬´_ìˆ˜ì •ì•ˆí•¨ || ë‹´ë‹¹ì—…ë¬´_ë™ì¼)) {
                return { matched: true, priority: 10 };
            }
        }

        // C0802: (ë°œì£¼ì²­ ì†Œì† ê¸°ìˆ ì¸) and (ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ í¬í•¨) and (ìˆ˜ì • ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ ë¯¸í¬í•¨)
        if (rule.ì¼€ì´ìŠ¤ID === 'C0802') {
            const ì°¸ì—¬ì‚¬ì—…ì¡°ê±´ =
                ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª… &&
                includesText(ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª…, 'ë³¸ì‚¬') &&
                !includesText(ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…, 'ë³¸ì‚¬');

            const ë°œì£¼ì²­ì¡°ê±´ = ë°œì£¼ì²­ì†Œì† === 'O';

            // ë‹´ë‹¹ì—…ë¬´ ì¡°ê±´ (C0801ê³¼ ë™ì¼)
            const ë‹´ë‹¹ì—…ë¬´_ìˆ˜ì •ì•ˆí•¨ = modifications['ë‹´ë‹¹ì—…ë¬´'] === undefined;
            const ë‹´ë‹¹ì—…ë¬´_ë™ì¼ =
                modifications['ë‹´ë‹¹ì—…ë¬´'] !== undefined &&
                ê¸°ì¡´_ë‹´ë‹¹ì—…ë¬´ === ìˆ˜ì •_ë‹´ë‹¹ì—…ë¬´;

            if (ì°¸ì—¬ì‚¬ì—…ì¡°ê±´ && ë°œì£¼ì²­ì¡°ê±´ && (ë‹´ë‹¹ì—…ë¬´_ìˆ˜ì •ì•ˆí•¨ || ë‹´ë‹¹ì—…ë¬´_ë™ì¼)) {
                return { matched: true, priority: 12 };
            }
        }

        // C0803: (ìˆ˜ì • ë‹´ë‹¹ì—…ë¬´ê°€ ì‹œê³µ) and (ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ í¬í•¨) and (ìˆ˜ì • ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ ë¯¸í¬í•¨)
        if (rule.ì¼€ì´ìŠ¤ID === 'C0803') {
            const ì°¸ì—¬ì‚¬ì—…ëª…_ë‹¤ë¦„ = ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª… && ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª… !== ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…;
            const ì°¸ì—¬ì‚¬ì—…1 = ['ë³¸ì‚¬'].includes(ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª…);
            const ì°¸ì—¬ì‚¬ì—…2 = !['ë³¸ì‚¬'].includes(ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…);
            const ë‹´ë‹¹ì—…ë¬´1 = ìˆ˜ì •_ë‹´ë‹¹ì—…ë¬´ === 'ì‹œê³µ'

            if (ì°¸ì—¬ì‚¬ì—…ëª…_ë‹¤ë¦„ && ì°¸ì—¬ì‚¬ì—…1 && ì°¸ì—¬ì‚¬ì—…2 && ë‹´ë‹¹ì—…ë¬´1) {
                return { matched: true, priority: 12 };
            }
        }

        // C0804: (ìˆ˜ì • ë‹´ë‹¹ì—…ë¬´ê°€ ì‹œê³µ) and (ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ í¬í•¨) and (ìˆ˜ì • ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ ë¯¸í¬í•¨) and (ì±…ì„ì •ë„ê°€ í˜„ì¥ëŒ€ë¦¬ì¸ ë˜ëŠ” í’ˆì§ˆê´€ë¦¬ì ë˜ëŠ” ì•ˆì „ê´€ë¦¬ì)
        if (rule.ì¼€ì´ìŠ¤ID === 'C0804') {
            const ì°¸ì—¬ì‚¬ì—…ëª…_ë‹¤ë¦„ = ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª… && ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª… !== ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…;
            const ì°¸ì—¬ì‚¬ì—…1 = ['ë³¸ì‚¬'].includes(ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª…);
            const ì°¸ì—¬ì‚¬ì—…2 = !['ë³¸ì‚¬'].includes(ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…);
            const ë‹´ë‹¹ì—…ë¬´1 = ìˆ˜ì •_ë‹´ë‹¹ì—…ë¬´ === 'ì‹œê³µ'
            const ì±…ì„ì •ë„1 = ['í˜„ì¥ëŒ€ë¦¬ì¸', 'í’ˆì§ˆê´€ë¦¬ì', 'ì•ˆì „ê´€ë¦¬ì'].includes(ì±…ì„ì •ë„)

            if (ì°¸ì—¬ì‚¬ì—…ëª…_ë‹¤ë¦„ && ì°¸ì—¬ì‚¬ì—…1 && ì°¸ì—¬ì‚¬ì—…2 && ë‹´ë‹¹ì—…ë¬´1 && ì±…ì„ì •ë„1) {
                return { matched: true, priority: 15 };
            }
        }

        // C0805: (ì°¸ì—¬ì‚¬ì—…ëª…ê³¼ ìˆ˜ì • ì°¸ì—¬ì‚¬ì—…ëª…ì´ ë‹¤ë¥¸ ê²½ìš°)
        if (rule.ì¼€ì´ìŠ¤ID === 'C0805') {
            const ì°¸ì—¬ì‚¬ì—…ëª…_ë‹¤ë¦„ = ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª… && ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª… !== ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…;
            
            if (ì°¸ì—¬ì‚¬ì—…ëª…_ë‹¤ë¦„) {
                return { matched: true, priority: 5 };
            }
        }
        
        // C0806: (ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ í¬í•¨) and (ìˆ˜ì • ì°¸ì—¬ì‚¬ì—…ëª…ì— ë³¸ì‚¬ê°€ í¬í•¨) (ì˜ˆì™¸ì¼€ì´ìŠ¤)
        if (rule.ì¼€ì´ìŠ¤ID === 'C0806') {
            const ì°¸ì—¬ì‚¬ì—…ì¡°ê±´ =
                ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª… &&
                includesText(ê¸°ì¡´_ì°¸ì—¬ì‚¬ì—…ëª…, 'ë³¸ì‚¬') &&
                includesText(ìˆ˜ì •_ì°¸ì—¬ì‚¬ì—…ëª…, 'ë³¸ì‚¬');

            if (ì°¸ì—¬ì‚¬ì—…ì¡°ê±´) {
                return { matched: true, priority: 7 };
            }
        }
        // C0901: ê¸°ê´€ í†µí•© ë˜ëŠ” ìƒí˜¸ë³€ê²½ ë“±ìœ¼ë¡œ ë³€ê²½ì´ í™•ì¸ë˜ëŠ” ê²½ìš°
        if (rule.ì¼€ì´ìŠ¤ID === 'C0901') {
            const ë°œì£¼ìì¡°ê±´ = ê¸°ì¡´_ë°œì£¼ì === 'ì„œìš¸ì§€í•˜ì² ê³µì‚¬' && 
                            ìˆ˜ì •_ë°œì£¼ì !== 'ì„œìš¸ë©”íŠ¸ë¡œ'

            if (ë°œì£¼ìì¡°ê±´) {
                return { matched: true, priority: 10 };
            }
        }
        // C0902: ê³µì‚¬ê³„ì•½ì„œ ë˜ëŠ” ì‹¤ì ì¦ëª…ì„œë¡œ ë°œì£¼ìëª…ì„ ë³€ê²½í•˜ëŠ” ê²½ìš°
        if (rule.ì¼€ì´ìŠ¤ID === 'C0902') {
            const ë°œì£¼ì_ë‹¤ë¦„ = ìˆ˜ì •_ë°œì£¼ì && ê¸°ì¡´_ë°œì£¼ì !== ìˆ˜ì •_ë°œì£¼ì;
            
            if (ë°œì£¼ì_ë‹¤ë¦„) {
                return { matched: true, priority: 7 };
            }
        }
        // C1201: êµ­í† ê°œë°œâ†’ì¡°ê²½/í† ëª©/ë„ì‹œêµí†µ ë˜ëŠ” ìì—°í† ì–‘â†’ìì—°í™˜ê²½/í† ì–‘í™˜ê²½
        if (rule.ì¼€ì´ìŠ¤ID === 'C1201') {
            const cond1 = ê¸°ì¡´_ì§ë¬´ë¶„ì•¼ === 'êµ­í† ê°œë°œ' && 
                        ['ì¡°ê²½', 'í† ëª©', 'ë„ì‹œÂ·êµí†µ'].includes(ìˆ˜ì •_ì§ë¬´ë¶„ì•¼);
            const cond2 = ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ === 'ìì—°Â·í† ì–‘' && 
                        ['ìì—°í™˜ê²½', 'í† ì–‘í™˜ê²½'].includes(ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼);
            if (cond1 || cond2) {
                return { matched: true, priority: 10 };
            }
        }

        // C1202: ì§ë¬´ë¶„ì•¼ê°€ ë‹¤ë¥´ê±°ë‚˜ ì „ë¬¸ë¶„ì•¼ê°€ ë‹¤ë¥¸ ê²½ìš° (ì¼ë°˜ì ì¸ ë³€ê²½) - ì‹¬ì˜
        if (rule.ì¼€ì´ìŠ¤ID === 'C1202') {
            const ì§ë¬´ë¶„ì•¼_ë‹¤ë¦„ = ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ && ê¸°ì¡´_ì§ë¬´ë¶„ì•¼ !== ìˆ˜ì •_ì§ë¬´ë¶„ì•¼;
            const ì „ë¬¸ë¶„ì•¼_ë‹¤ë¦„ = ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ && ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ !== ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼;
            const í™˜ê²½í† ì–‘ = ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ === 'í™˜ê²½' && ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'í† ì–‘í™˜ê²½';
            
            if (ì§ë¬´ë¶„ì•¼_ë‹¤ë¦„ || ì „ë¬¸ë¶„ì•¼_ë‹¤ë¦„ || í™˜ê²½í† ì–‘) {
                return { matched: true, priority: 5 };
            }
        }

        // C1203: ê±´ì¶•/ê±´ì¶•ê¸°ê³„ì„¤ë¹„ â†” ê¸°ê³„/ê³µì¡°ëƒ‰ë™ë°ì„¤ë¹„
        if (rule.ì¼€ì´ìŠ¤ID === 'C1203') {
            const cond1 = ê¸°ì¡´_ì§ë¬´ë¶„ì•¼ === 'ê±´ì¶•' && ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ === 'ê±´ì¶•ê¸°ê³„ì„¤ë¹„' &&
                        ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ === 'ê¸°ê³„' && ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'ê³µì¡°ëƒ‰ë™ë°ì„¤ë¹„';
            const cond2 = ê¸°ì¡´_ì§ë¬´ë¶„ì•¼ === 'ê¸°ê³„' && ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ === 'ê³µì¡°ëƒ‰ë™ë°ì„¤ë¹„' &&
                        ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ === 'ê±´ì¶•' && ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'ê±´ì¶•ê¸°ê³„ì„¤ë¹„';
            if (cond1 || cond2) {
                // ì¢…ë£Œì‹ ê³ ì¼ì´ 2014.05.22 ì´ì „ì´ë©´ ì¶”ê°€ ì„œë¥˜ í•„ìš”
                const needsExtraDoc = ì¢…ë£Œì‹ ê³ ì¼ && ì¢…ë£Œì‹ ê³ ì¼ < '2014.05.22';
                return { matched: true, priority: 15, needsExtraDoc: needsExtraDoc };
            }
        }

        // C1204: ë³´ìœ ê±´ì„¤ì—…ì— í•´ë‹¹í•˜ëŠ” ì§ë¬´ë¶„ì•¼ë¡œ ìˆ˜ì •
        if (rule.ì¼€ì´ìŠ¤ID === 'C1204') {
            if (ë³´ìœ ê±´ì„¤ì—… === 'ê±´ì¶•ê³µì‚¬ì—…' && ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ === 'ê±´ì¶•') {
                // ê±´ì¶•ê³µì‚¬ì—… â†’ ê±´ì¶• ì§ë¬´ë¶„ì•¼ ë§¤ì¹­
                return { matched: true, priority: 8 };
            } else if (ë³´ìœ ê±´ì„¤ì—… === 'í† ëª©ê³µì‚¬ì—…' && ìˆ˜ì •_ì§ë¬´ë¶„ì•¼ === 'í† ëª©') {
                // í† ëª©ê³µì‚¬ì—… â†’ í† ëª© ì§ë¬´ë¶„ì•¼ ë§¤ì¹­
                return { matched: true, priority: 8 };
            }
        }

        // C1205: í’ˆì§ˆ/ì•ˆì „ê´€ë¦¬ì â†’ í’ˆì§ˆê´€ë¦¬ ì „ë¬¸ë¶„ì•¼
        if (rule.ì¼€ì´ìŠ¤ID === 'C1205') {
            const isí’ˆì§ˆì•ˆì „ê´€ë¦¬ì = ['í’ˆì§ˆê´€ë¦¬ì', 'ì•ˆì „ê´€ë¦¬ì'].includes(ì±…ì„ì •ë„);
            const ê¸°ì¡´_notí’ˆì§ˆê´€ë¦¬ = !['í† ëª©í’ˆì§ˆê´€ë¦¬', 'ê±´ì¶•í’ˆì§ˆê´€ë¦¬'].includes(ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼);
            const ìˆ˜ì •_í’ˆì§ˆê´€ë¦¬ = ['í† ëª©í’ˆì§ˆê´€ë¦¬', 'ê±´ì¶•í’ˆì§ˆê´€ë¦¬'].includes(ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼);
            
            if (isí’ˆì§ˆì•ˆì „ê´€ë¦¬ì && ê¸°ì¡´_notí’ˆì§ˆê´€ë¦¬ && ìˆ˜ì •_í’ˆì§ˆê´€ë¦¬) {
                return { matched: true, priority: 12 };
            }
        }

        // C1206: ì‹œí—˜â†’í’ˆì§ˆê´€ë¦¬, ì „ë¬¸ë¶„ì•¼â†’í† ëª©í’ˆì§ˆê´€ë¦¬
        if (rule.ì¼€ì´ìŠ¤ID === 'C1206') {
            const cond = ê¸°ì¡´_ë‹´ë‹¹ì—…ë¬´ === 'ì‹œí—˜' && 
                        ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ !== 'í† ëª©í’ˆì§ˆê´€ë¦¬' &&
                        ìˆ˜ì •_ë‹´ë‹¹ì—…ë¬´ === 'í’ˆì§ˆê´€ë¦¬' && 
                        ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'í† ëª©í’ˆì§ˆê´€ë¦¬';
            if (cond) {
                return { matched: true, priority: 12 };
            }
        }

        // C1207: ê±´ì¶•êµ¬ì¡°â†’ê±´ì¶•ê³„íšì„¤ê³„ (ì¢…ë£Œì¼ â‰¤ 2010.02.02)
        if (rule.ì¼€ì´ìŠ¤ID === 'C1207') {
            const cond1 = ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ === 'ê±´ì¶•êµ¬ì¡°' && ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'ê±´ì¶•ê³„íšÂ·ì„¤ê³„';
            const cond2 = ì¢…ë£Œì‹ ê³ ì¼ && ì¢…ë£Œì‹ ê³ ì¼ <= '2010.02.02';
            if (cond1 && cond2) {
                return { matched: true, priority: 15 };
            }
        }

        // C1208: ê±´ì¶•êµ¬ì¡°â†’ê±´ì¶•ê³„íšì„¤ê³„ (ì¢…ë£Œì¼ > 2010.02.02)
        if (rule.ì¼€ì´ìŠ¤ID === 'C1208') {
            const cond1 = ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ === 'ê±´ì¶•êµ¬ì¡°' && ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'ê±´ì¶•ê³„íšÂ·ì„¤ê³„';
            const cond2 = ì¢…ë£Œì‹ ê³ ì¼ && ì¢…ë£Œì‹ ê³ ì¼ > '2010.02.02';
            if (cond1 && cond2) {
                return { matched: true, priority: 15 };
            }
        }

        // C1209: ì¸¡ëŸ‰ë°ì§€í˜•ê³µê°„ì •ë³´â†’ì§€ì  (í•œêµ­êµ­í† ì •ë³´ê³µì‚¬)
        if (rule.ì¼€ì´ìŠ¤ID === 'C1209') {
            const cond = ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼ === 'ì¸¡ëŸ‰ë°ì§€í˜•ê³µê°„ì •ë³´' && 
                        ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼ === 'ì§€ì ' &&
                        ê·¼ë¬´ì²˜ëª… && ê·¼ë¬´ì²˜ëª….includes('í•œêµ­êµ­í† ì •ë³´ê³µì‚¬');
            if (cond) {
                return { matched: true, priority: 15 };
            }
        }

        // C1210: ì¼ë°˜ë¶„ì•¼â†’ì‹œê³µë¶„ì•¼ (ë³´ìœ ê±´ì„¤ì—… ìˆìŒ)
        if (rule.ì¼€ì´ìŠ¤ID === 'C1210') {
            const ê¸°ì¡´_notì‹œê³µ = !['ê±´ì¶•ì‹œê³µ', 'í† ëª©ì‹œê³µ'].includes(ê¸°ì¡´_ì „ë¬¸ë¶„ì•¼);
            const ìˆ˜ì •_ì‹œê³µ = ['ê±´ì¶•ì‹œê³µ', 'í† ëª©ì‹œê³µ'].includes(ìˆ˜ì •_ì „ë¬¸ë¶„ì•¼);
            const hasë³´ìœ ê±´ì„¤ì—… = ë³´ìœ ê±´ì„¤ì—… && ë³´ìœ ê±´ì„¤ì—….trim() !== '';
            
            if (ê¸°ì¡´_notì‹œê³µ && ìˆ˜ì •_ì‹œê³µ && hasë³´ìœ ê±´ì„¤ì—…) {
                return { matched: true, priority: 12 };
            }
        }
    
        return { matched: false, priority: 0 };
    }

    // Step4: ì„œë¥˜ ì—…ë¡œë“œ
    function renderStep4(content) {
        const rule = state.matchedRule;

        let html = `
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-upload mr-2 text-blue-600"></i>
                í•„ìˆ˜ ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”
            </h2>
        `;

        if (!rule) {
            html += `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <p class="text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i>ë§¤ì¹­ë˜ëŠ” ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.</p>
                </div>
            `;
        } else {
            html += `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-bold text-gray-800 mb-2">ì²˜ë¦¬ ìœ í˜•</h3>
                    <p class="text-blue-800 text-lg">${rule.ì²˜ë¦¬ìœ í˜•ê²°ì •}</p>
                </div>

                <h3 class="font-bold text-lg mb-4 text-gray-700">í•„ìˆ˜ ì„œë¥˜ ëª©ë¡</h3>
                <div class="space-y-4">
            `;

            // í•„ìˆ˜ì„œë¥˜ í•„ë“œë“¤ ì°¾ê¸°
            let docCount = 0;
            for (let i = 1; i <= 6; i++) {
                const docField = `í•„ìˆ˜ì„œë¥˜${i}`;
                const docName = rule[docField];
                
                if (docName && docName.trim() !== '') {
                    docCount++;
                    const fileId = `file-${i}`;
                    const uploadedFile = state.uploadedFiles[docName];

                    html += `
                        <div class="border border-gray-300 rounded-lg p-4">
                            <label class="block font-medium text-gray-700 mb-2">
                                ${docCount}. ${docName}
                            </label>
                            <div class="flex items-center gap-3">
                                <input type="file" 
                                    id="${fileId}" 
                                    class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    onchange="handleFileUpload('${docName}', '${fileId}')">
                                <button onclick="removeFile('${docName}', '${fileId}')" 
                                    class="px-3 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 ${uploadedFile ? '' : 'hidden'}" 
                                    id="${fileId}-remove">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div id="${fileId}-name" class="mt-2 text-sm text-green-600 ${uploadedFile ? '' : 'hidden'}">
                                <i class="fas fa-check-circle mr-1"></i>${uploadedFile ? uploadedFile.name : ''}
                            </div>
                        </div>
                    `;
                }
            }

            // C1203 ì¶”ê°€ ì„œë¥˜ (ì¢…ë£Œì‹ ê³ ì¼ì´ 2014.05.22 ì´ì „)
            if (state.needsExtraDoc) {
                docCount++;
                const extraDocName = 'ê²½ë ¥ë³€ê²½ì‹ ê³ ì„œ ë˜ëŠ” ê²½ë ¥ì¦ëª…ì„œ';
                const fileId = `file-extra`;
                const uploadedFile = state.uploadedFiles[extraDocName];

                html += `
                    <div class="border border-orange-300 rounded-lg p-4 bg-orange-50">
                        <label class="block font-medium text-orange-700 mb-2">
                            ${docCount}. ${extraDocName}
                            <span class="text-sm text-orange-600 ml-2">(ì¢…ë£Œì‹ ê³ ì¼ì´ 2014.05.22 ì´ì „)</span>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="file" 
                                id="${fileId}" 
                                class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"
                                onchange="handleFileUpload('${extraDocName}', '${fileId}')">
                            <button onclick="removeFile('${extraDocName}', '${fileId}')" 
                                class="px-3 py-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 ${uploadedFile ? '' : 'hidden'}" 
                                id="${fileId}-remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div id="${fileId}-name" class="mt-2 text-sm text-green-600 ${uploadedFile ? '' : 'hidden'}">
                            <i class="fas fa-check-circle mr-1"></i>${uploadedFile ? uploadedFile.name : ''}
                        </div>
                    </div>
                `;
            }

            html += `
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        í”„ë¡œí† íƒ€ì…ì—ì„œëŠ” íŒŒì¼ ì—…ë¡œë“œ ì—†ì´ë„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            `;
        }

        content.innerHTML = html;
    }

    // íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    function handleFileUpload(docName, fileId) {
        const input = document.getElementById(fileId);
        const file = input.files[0];
        
        if (file) {
            state.uploadedFiles[docName] = file;
            document.getElementById(`${fileId}-name`).textContent = file.name;
            document.getElementById(`${fileId}-name`).classList.remove('hidden');
            document.getElementById(`${fileId}-remove`).classList.remove('hidden');
            console.log('íŒŒì¼ ì—…ë¡œë“œ:', docName, file.name);
        }
    }

    // íŒŒì¼ ì‚­ì œ í•¸ë“¤ëŸ¬
    function removeFile(docName, fileId) {
        delete state.uploadedFiles[docName];
        document.getElementById(fileId).value = '';
        document.getElementById(`${fileId}-name`).classList.add('hidden');
        document.getElementById(`${fileId}-remove`).classList.add('hidden');
        console.log('íŒŒì¼ ì‚­ì œ:', docName);
    }

    // ì œì¶œ ë°ì´í„° ì¤€ë¹„
    function prepareSubmissionData() {
        state.submissionData = {
            selectedItems: state.selectedItems,
            selectedCareer: state.selectedCareer,
            modifiedFields: state.modifiedFields,
            matchedRule: state.matchedRule,
            uploadedFiles: Object.keys(state.uploadedFiles).map(name => ({
                name: name,
                fileName: state.uploadedFiles[name].name
            })),
            timestamp: new Date().toISOString()
        };

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        localStorage.setItem('careerModification', JSON.stringify(state.submissionData));
        console.log('ì œì¶œ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ:', state.submissionData);
    }

    // Step5: ìš”ì•½ ë° ì œì¶œ
    function renderStep5(content) {
        const data = state.submissionData;

        let html = `
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                <i class="fas fa-clipboard-check mr-2 text-blue-600"></i>
                ì œì¶œ ë‚´ìš© í™•ì¸
            </h2>
            <p class="text-gray-600 mb-6">ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì‹  í›„ ì œì¶œ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.</p>
            
            <!-- ìˆ˜ì • í•­ëª© -->
            <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                <h3 class="font-bold text-lg mb-2 text-gray-700">ì„ íƒí•œ ìˆ˜ì • í•­ëª©</h3>
                <div class="flex flex-wrap gap-2">
        `;

        data.selectedItems.forEach(code => {
            const item = state.data.table1.find(i => i.í•­ëª©ì½”ë“œ === code);
            html += `
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                    ${item ? item.í•­ëª©ëª… : code}
                </span>
            `;
        });

        html += `
                </div>
            </div>

            <!-- ì„ íƒí•œ ê²½ë ¥ -->
            <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                <h3 class="font-bold text-lg mb-2 text-gray-700">ì„ íƒí•œ ê²½ë ¥</h3>
                <div class="text-sm text-gray-600">
                    ê·¼ë¬´ì²˜: <strong>${data.selectedCareer.ê·¼ë¬´ì²˜ëª… || '-'}</strong>, 
                    ì…ì‚¬ì¼: <strong>${data.selectedCareer.ì…ì‚¬ì¼ || '-'}</strong>, 
                    í‡´ì‚¬ì¼: <strong>${data.selectedCareer.í‡´ì‚¬ì¼ || '-'}</strong>
                </div>
            </div>

            <!-- ìˆ˜ì • ë‚´ìš© -->
            <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                <h3 class="font-bold text-lg mb-2 text-gray-700">ìˆ˜ì • ë‚´ìš©</h3>
                <div class="space-y-2">
        `;

        Object.entries(data.modifiedFields).forEach(([key, newValue]) => {
            const oldValue = data.selectedCareer[key] || '-';
            html += `
                <div class="flex items-start text-sm">
                    <div class="w-1/3 text-gray-600 font-medium">${key}</div>
                    <div class="w-1/3">
                        <span class="line-through text-red-500">${oldValue}</span>
                    </div>
                    <div class="w-1/3">
                        <span class="text-green-600 font-semibold">${newValue}</span>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>

            <!-- ì²˜ë¦¬ ìœ í˜• ë° í•„ìˆ˜ ì„œë¥˜ -->
        `;

        if (data.matchedRule) {
            html += `
                <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-2 text-gray-700">ì²˜ë¦¬ ìœ í˜•</h3>
                    <p class="text-blue-800 font-semibold">${data.matchedRule.ì²˜ë¦¬ìœ í˜•ê²°ì •}</p>
                </div>

                <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-2 text-gray-700">ì—…ë¡œë“œí•œ ì„œë¥˜</h3>
            `;

            if (data.uploadedFiles.length > 0) {
                html += `<ul class="space-y-1">`;
                data.uploadedFiles.forEach(file => {
                    html += `
                        <li class="text-sm text-gray-700">
                            <i class="fas fa-file-alt mr-2 text-blue-600"></i>
                            ${file.name}: ${file.fileName}
                        </li>
                    `;
                });
                html += `</ul>`;
            } else {
                html += `<p class="text-gray-500 text-sm">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            html += `</div>`;
        }

        html += `
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-6">
                <p class="text-sm text-green-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    ì œì¶œ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì‹ ì²­ì´ ì™„ë£Œë©ë‹ˆë‹¤.
                </p>
            </div>
        `;

        content.innerHTML = html;

        // ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë³€ê²½
        const nextBtn = document.getElementById('btn-next');
        nextBtn.onclick = submitApplication;
    }

    // ì œì¶œ ì²˜ë¦¬
    function submitApplication() {
        console.log('ì œì¶œ ì²˜ë¦¬:', state.submissionData);
        
        showModal(`
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-3xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">ì œì¶œ ì™„ë£Œ (í”„ë¡œí† íƒ€ì…)</h3>
                <p class="text-gray-600">ê²½ë ¥ ìˆ˜ì • ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-500 mt-2">ë°ì´í„°ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
        `);

        // ëª¨ë‹¬ ë‹«ê¸° í›„ ì´ˆê¸°í™”
        document.getElementById('modal-close').onclick = () => {
            closeModal();
            resetApplication();
        };
    }

    // ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
    function resetApplication() {
        state.currentStep = 1;
        state.selectedItems = [];
        state.selectedCareer = null;
        state.modifiedFields = {};
        state.matchedRule = null;
        state.needsExtraDoc = false;
        state.uploadedFiles = {};
        state.submissionData = null;
        
        renderStep(1);
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë³µì›
        document.getElementById('btn-next').onclick = handleNext;
    }

    // ê³µí†µ ìœ í‹¸ í•¨ìˆ˜1 (ë¬¸ì í¬í•¨ ì—¬ë¶€)
    function includesText(value, keyword) {
        if (!value || !keyword) return false;
        return value.includes(keyword);
    }

    // ëª¨ë‹¬ í‘œì‹œ
    function showModal(content) {
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('modal').classList.remove('hidden');
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', init);

  </script>

</body>
</html>
